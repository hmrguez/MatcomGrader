using Common;
using Exam;
using Grader;
using NUnit.Framework.Interfaces;

namespace AutoGrader;

[TestFixture]
public class Tests
{
    // Configuration Constants
    private const int NumberOfCases = 10;
    private const int RandomSeed = 10;
    private const string MdPath = "../../../../results.md";
    private static readonly string[] MdHeaders = ["Name", "Passed", "Exceptions", "Timeouts"];


    // Counters to track test outcomes
    private int _passedCount;
    private int _exceptionCount;
    private int _timeoutCount;

    [TearDown]
    public void TearDown()
    {
        // Determine the outcome of the test
        var outcome = TestContext.CurrentContext.Result.Outcome.Status;
        var message = TestContext.CurrentContext.Result.Message;

        Console.WriteLine("Outcome: " + outcome);
        Console.WriteLine("Message: " + message);

        switch (outcome)
        {
            case TestStatus.Passed:
                _passedCount++;
                break;
            case TestStatus.Failed:
                if (message!.Contains("Timeout"))
                {
                    _timeoutCount++;
                }
                else
                {
                    _exceptionCount++;
                }

                break;
        }
    }

    [Test, Timeout(5000)]
    [TestCaseSource(nameof(GetTestCases))]
    public void AutoGeneratedSolutions(int input, int expectedOutput)
    {
        var solved = Solution.Solve(input);
        Assert.That(solved, Is.EqualTo(expectedOutput));
    }

    /// <summary>
    /// This method runs once after all tests in this fixture have executed.
    /// It's used for any necessary cleanup and writing to the .md file.
    /// </summary>
    [OneTimeTearDown]
    public void OneTimeTearDown()
    {
        var writer = new MarkdownWriter(MdPath, MdHeaders);

        writer.AddRow("Jose", _passedCount.ToString(), _exceptionCount.ToString(), _timeoutCount.ToString());

        Console.WriteLine("Test summary written to results.md");
    }

    /// <summary>
    /// Provides test cases for the AutoGeneratedSolutions test method.
    /// </summary>
    /// <returns>An enumerable of TestCaseData, each containing input and expected output.</returns>
    public static IEnumerable<TestCaseData> GetTestCases()
    {
        foreach (var testCase in Generator.GenerateTestCases(RandomSeed, NumberOfCases))
        {
            yield return new TestCaseData(testCase[0], testCase[1])
                .SetName($"Input_{testCase[0]}_Expected_{testCase[1]}");
        }
    }
}